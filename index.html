<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hangar Avion</title>
  <style>
    body { font-family: Arial; max-width: 700px; margin: auto; padding: 1em; background: #e3f2fd; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
    nav button, #logout-btn { background: #0288d1; color: white; border: none; padding: 0.5em 1em; margin-right: 0.5em; border-radius:4px; cursor: pointer; }
    .section { display: none; background: white; padding:1em; border-radius:8px; margin-top:1em; }
    #profile-modal { position:fixed; top:60px; right:10px; background:white; padding:15px; border:1px solid #ccc; border-radius:8px; display:none; z-index:100; }
    img.avatar, .photo-thumb, .shop-item img, .hangar-item img { border-radius:8px; }
    img.avatar { width:40px; height:40px; object-fit:cover; cursor:pointer; }
    .photo-thumb, .shop-item img, .hangar-item img { max-width:150px; display:block; margin-bottom:5px; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    table th, table td { border:1px solid #ccc; padding: 8px; text-align:center; }
  </style>
</head>
<body>

<header>
  <div><img src="default-avatar.png" id="avatar" class="avatar" alt="Avatar"/><span id="points-header">0 pts</span></div>
  <nav>
    <button onclick="showSection('photo')">üì∏ Photo</button>
    <button onclick="showSection('shop')">üè™ Boutique</button>
    <button onclick="showSection('hangar')">üõ©Ô∏è Hangar</button>
  </nav>
  <button id="logout-btn" style="display:none;">D√©connexion</button>
</header>

<div id="profile-modal">
  <p><strong>Email : </strong><span id="profile-email"></span></p>
  <p><strong>Cr√©dits : </strong><span id="profile-credits">0</span></p>
  <p><strong>Points : </strong><span id="profile-points">0</span></p>
</div>

<section id="login-section" class="section" style="display:block;">
  <h2>Connexion / Inscription</h2>
  <input type="email" id="email" placeholder="Email" /><br><br>
  <input type="password" id="password" placeholder="Mot de passe" /><br><br>
  <button id="login-btn">Connexion</button>
  <button id="signup-btn">Cr√©er un compte</button>
</section>

<section id="photo" class="section">
  <h2>üì∏ Prends une photo d‚Äôun avion !</h2>
  <input type="file" accept="image/*" capture="environment" id="photo-input" />
</section>

<section id="shop" class="section">
  <h2>üè™ Boutique</h2>
  <div id="shop-items"></div>
</section>

<section id="hangar" class="section">
  <h2>üõ©Ô∏è Ton Hangar</h2>
  <table id="hangar-table">
    <thead><tr><th>Avion</th><th>Image</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
  'https://ixntiwcgvljrjbjnfjti.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4bnRpd2Nndmxqcmpiam5manRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxNzk2NzcsImV4cCI6MjA2NTc1NTY3N30.lygU6ARA0EO99u3zPNbZ6GgtzmIKUZMcmlsbDLP4kBk'
);

let user = null;

const avatarImg = document.getElementById('avatar');
const profileModal = document.getElementById('profile-modal');
const logoutBtn = document.getElementById('logout-btn');
const pointsHeader = document.getElementById('points-header');

// Toggle profil modal
avatarImg.addEventListener('click', () => {
  profileModal.style.display = profileModal.style.display === 'none' ? 'block' : 'none';
});

// Show/hide sections
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  document.getElementById(id).style.display = 'block';
  profileModal.style.display = 'none';
}

// Session check
async function checkSession() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    user = session.user;
    document.getElementById('login-section').style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    showSection('photo');
    await loadProfile();
    await loadShop();
    await loadHangar();
  }
}

// Load profile
async function loadProfile() {
  const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
  if (!profile) return;
  document.getElementById('profile-email').textContent = profile.email;
  document.getElementById('profile-credits').textContent = profile.credits;
  document.getElementById('profile-points').textContent = profile.points;
  pointsHeader.textContent = profile.points + ' pts';
  avatarImg.src = profile.avatar_url || 'default-avatar.png';
}

// Load shop
async function loadShop() {
  const { data: items, error } = await supabase.from('shop_items').select('*');
  if (error) return console.error(error);
  const container = document.getElementById('shop-items');
  container.innerHTML = '';
  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'shop-item';
    div.innerHTML = `
      <h3>${item.name}</h3>
      <img src="${item.image_url}" alt="${item.name}" />
      <p>Prix : ${item.price} cr√©dits</p>
      <button onclick="buyItem('${item.name}',${item.price},'${item.image_url}')">Acheter</button>
    `;
    container.appendChild(div);
  });
}

// Purchase handler
window.buyItem = async function(name,price,imgUrl) {
  if (!user) return alert("Connectez-vous d'abord");
  const { data: p } = await supabase.from('profiles').select('credits,planes').eq('id',user.id).single();
  if (p.credits < price) return alert("‚ùå Cr√©dits insuffisants !");
  await supabase.from('profiles').update({
    credits: p.credits - price, planes: p.planes+1
  }).eq('id', user.id);
  await supabase.from('hangar').insert({ user_id: user.id, plane: name, image_url: imgUrl });
  alert("‚úÖ Vous avez achet√© " + name);
  await loadProfile();
  await loadHangar();
};

// Load hangar (table of purchased and taken photos)
async function loadHangar() {
  const { data: bought } = await supabase.from('hangar').select('plane,image_url').eq('user_id', user.id);
  const { data: photos } = await supabase.from('photos').select('url').eq('user_id',user.id);
  const tbody = document.querySelector('#hangar-table tbody');
  tbody.innerHTML = '';
  bought.forEach(b => {
    const row = tbody.insertRow();
    row.insertCell().textContent = b.plane;
    const imgC = row.insertCell(); imgC.innerHTML = `<img src="${b.image_url}" class="hangar-item" />`;
  });
  photos.forEach(ph => {
    const row = tbody.insertRow();
    row.insertCell().textContent = 'Photo';
    const imgC = row.insertCell(); imgC.innerHTML = `<img src="${ph.url}" class="hangar-item" />`;
  });
}

// Photo upload
document.getElementById('photo-input').addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file || !user) return alert("Fichier invalide ou non connect√©");
  const fn = `${user.id}/${Date.now()}-${file.name}`;
  const { error: upE } = await supabase.storage.from('photos').upload(fn, file);
  if (upE) return alert("Erreur upload : " + upE.message);
  const { data: { publicUrl } } = supabase.storage.from('photos').getPublicUrl(fn);
  await supabase.from('photos').insert({ user_id: user.id, url: publicUrl });
  const { data: pr } = await supabase.from('profiles').select('credits,points').eq('id',user.id).single();
  await supabase.from('profiles').update({
    credits: pr.credits + 1500, points: pr.points + 200
  }).eq('id', user.id);
  alert("üì∏ Photo enregistr√©e !");
  await loadProfile();
  await loadHangar();
});

// Auth handlers
document.getElementById('login-btn').onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) return alert(error.message);
  await checkSession();
};

document.getElementById('signup-btn').onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const { data, error } = await supabase.auth.signUp({ email, password });
  if (error) return alert(error.message);
  await supabase.from('profiles').insert({
    id: data.user.id, email: data.user.email,
    credits: 0, points: 0, planes: 0,
    avatar_url: 'default-avatar.png'
  });
  await checkSession();
};

logoutBtn.onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

// App start
checkSession();

</script>
</body>
</html>
